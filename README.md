# pio-clangd

This project attempts to address the challenges of using clangd as the language server for PlatformIO projects. The primary use case is to use clangd as the language server in Neovim and other editors.

`pio-clangd` is a `compile_commands.json` generator in the project root that provides enough compiler flags to build an AST, but strips the ones that are not clangd compatible. `pio-clangd` takes the `compile_commands.json` generated by the PlatformIO CLI as input and transforms it into a form that works better with clangd.  If the PlatformIO project has multiple environments, pio-clangd will build an aggregated `compile_commands.json` prioritized for the target environment, but also adding file entries for all environments using a "best guess" approach. This aggregated `compile_commands.json` has duplicate entries removed. 

## Integration with PlatformIO

1. Configure PlatformIO to generate `compile_commands.json` in each environment's build directory rather than the project root. Add this to `platformio.ini`:

```ini
...
extra_scripts = post:env_compiledb.py
...
```

Use the provided script at `pio-clangd/scripts/env_compiledb.py` or adapt it for your configuration.

2. Build a `compile_commands.json` for all environments using the PlatformIO CLI.

```bash
pio run -t compiledb
```

3. Invoke `pio-clangd` in the project root to output the aggregated `compile_commands.json`. 

```bash
# cd into project root. 
# Assumes pio-clangd is installed in system PATH
pio-clangd
```

4. Optional: Add a `.clangd` file to the PlatformIO project root to fine-tune clangd as needed.

## How to build pio-clangd

```bash
git clone https://github.com/gunlock/pio-clangd.git
cd pio-clangd

# Configure (choose your preferred generator):
cmake -S . -B build -G "Ninja"        # Ninja (Linux/macOS)
# cmake -S . -B build -G "Xcode"      # Xcode (macOS)

# Build (change -j16 to match your CPU cores)
cmake --build build -j16 --config Release
```

Move `pio-clangd` to your user `bin` folder configured for your PATH.

## pio-clangd options

```bash
pio-clangd --help
```
